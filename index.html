<html>
<head>
	<title>Testing</title>
	<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
	<script src="rbush.js"></script>

	<script src="3D/util.js"></script>
	<script src="3D/Three.min.js"></script>
	<script src="3D/OrbitControls.js"></script>
	<script src="3D/Draw.js"></script>
	<script src="3D/Viewport.js"></script>
	<script src="3D/PackingViewport.js"></script>
	<script src="3D/HUD.js"></script>
	<script src="3D/SceneManager.js"></script>

	<script>
		var SVG = {
			new: function(tagName){
				return document.createElementNS("http://www.w3.org/2000/svg", tagName)
			}
		}

		var domContainer = null;
		var sm = null;

		$(document).ready(function(){
			domContainer = $(SVG.new("svg"))
				.attr("id", "viewport")
				.attr("height", 768)
				.attr("width", 1024)
				.css({position: "absolute"})
				.appendTo("#main");

			var view = new PackingViewport({renderTo: "#main3d", vertMargin: 100});
			
			sm = new SceneManager();
			sm.attachTo(view);
			
		});

		function drawLine(p1, p2, color){
			if(!color){
				var color = "0,0,0";
			}
			$(SVG.new("line")).attr({
				x1: p1[0], 
				y1: p1[1], 
				x2: p2[0], 
				y2: p2[1],
				style: "stroke:rgb("+color+");stroke-width:1"})
			.appendTo(domContainer);
		}

		function drawBox(p, color){
			if(!color){
				var color = "0,0,255";
			}

			var x1 = p[0];
			var y1 = p[1];
			var z1 = p[2];
			var x2 = p[3];
			var y2 = p[4];
			var z2 = p[5];

			drawLine([x1,y1],[x2,y1], color);
			drawLine([x2,y1],[x2,y2], color);
			drawLine([x2,y2],[x1,y2], color);
			drawLine([x1,y2],[x1,y1], color);

			sm.addBox([x1,y1,z1,x2,y2,z2], color);
		}

		function box(x, y, z, w, h, l){
			return [x, y, z, x+w, y+h, z+l];
		}

		function randomItems(count){
			var items = [];
			var spread = 400;
			var size = 80
			for(var i=0; i<count; i++){
				var x = Math.random()*spread;
				var y = Math.random()*spread;
				var z = Math.random()*spread;
				var w = Math.random()*size;
				var h = Math.random()*size;
				var l = Math.random()*size;
				items.push([x, y, z, x+w, y+h, z+l]);
			}
			return items;
		}

		function renderTree(data, faded){
			drawBox(data.bbox);
			for(var i=0; i<data.children.length; i++){
				if(data.leaf){
					drawBox(data.children[i], (faded ? "220,220,220" : "255,0,0"));
				}else{
					renderTree(data.children[i], faded);
				}
			}

		}

		function boxCenter(box){
			return [box[0]+(box[3]-box[0])/2,box[1]+(box[4]-box[1])/2,box[2]+(box[5]-box[2])/2];
		}
	</script>

	<script>

		$(document).ready(function(){
			var tree = rbush(20);

			var items = [
				box(20, 40, 0, 50, 50, 40),
				box(10, 10, 10, 10, 10, 15),
				box(30, 20, 50, 20, 20, 25),
				box(10, 20, 80, 25, 20, 30)
			];

			items = randomItems(100);
			tree.load(items);

			// for(var i=0; i<items.length; i++){
			// 	tree.insert(items[i]);
			// //	drawBox(items[i]);
			// }

			var criteria = box(10, 121, 130, 80, 80, 80);
			drawBox(criteria, "0,255,0");
			var result = tree.search(criteria);

			 for(var i=0; i<result.length; i++){
				drawBox(result[i], "255,0,0");
			 }


			var cameraFocus = boxCenter(criteria);
			sm.viewport.controls.target.x = -cameraFocus[0]*sm.getScale();
			sm.viewport.controls.target.y = -cameraFocus[1]*sm.getScale();
			sm.viewport.controls.target.z = -cameraFocus[2]*sm.getScale();
			renderTree(tree.toJSON(), true);
			console.log(result.length);



		});
	</script>
</head>
<body>
	<div id="main" style="position: relative; overlow: auto;">

	</div>
	<div id="main3d" style="position: relative; overlow: auto;">

	</div>
</body>
</html>